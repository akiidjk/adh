services:
  webhook:
    build: ./webhook
    container_name: webhook
    ports:
      - "${WEBHOOK_PORT:-8000}:8000"
    environment:
      - LOG_LEVEL=${LOG_LEVEL}
      - REDIS_ADDR=${REDIS_ADDR:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - redis
    volumes:
      - ./adh-webhook/logs:/tmp/webhook
    profiles:
      - full

  dashboard:
    build: ./dashboard
    container_name: dashboard
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - USER_ID=${USER_ID:-0}
      - USER_NAME=${USER_NAME:-user}
      - USER_PASSWORD=${USER_PASSWORD:-password}
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./adh-dashboard/logs:/tmp/webhook
    profiles:
      - full

  redis:
    image: redis/redis-stack-server:latest
    container_name: redis
    environment:
      - REDIS_ARGS=--requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redisinsight:
    image: redis/redisinsight:latest
    ports:
      - "5540:5540"
    volumes:
      - redis-insight:/data

volumes:
  redis_data:
    driver: local
  redis-insight:
